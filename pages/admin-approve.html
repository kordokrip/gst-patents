<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>관리자 승인 페이지 - GST 특허관리시스템</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'korean': ['Noto Sans KR', 'sans-serif']
                    },
                    colors: {
                        'gst-blue': '#1e40af',
                        'gst-light-blue': '#3b82f6',
                        'gst-gray': '#6b7280',
                        'gst-dark': '#1f2937'
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Noto Sans KR', sans-serif;
        }
    </style>
</head>
<body class="font-korean p-4">
    <div class="container mx-auto max-w-6xl">
        <!-- 헤더 -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-gst-blue to-gst-light-blue p-6 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-user-shield text-3xl text-gst-blue"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">관리자 승인 페이지</h1>
                            <p class="text-blue-100 text-sm">AI 질의 서비스 가입 신청 관리</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-blue-100" id="admin-info">로그인 필요</p>
                        <button id="logout-btn" class="mt-2 text-xs bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded transition-all hidden">
                            <i class="fas fa-sign-out-alt mr-1"></i>로그아웃
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 로그인 모달 (관리자 인증) -->
        <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <h2 class="text-2xl font-bold text-gst-dark mb-6 text-center">
                    <i class="fas fa-lock text-gst-blue mr-2"></i>
                    관리자 인증
                </h2>
                <form id="admin-login-form" class="space-y-4">
                    <div>
                        <label for="admin-email" class="block text-sm font-medium text-gst-gray mb-2">
                            관리자 이메일
                        </label>
                        <input 
                            type="email" 
                            id="admin-email" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gst-blue"
                            placeholder="admin@gst-in.com"
                            required
                        >
                    </div>
                    <div>
                        <label for="admin-password" class="block text-sm font-medium text-gst-gray mb-2">
                            비밀번호
                        </label>
                        <input 
                            type="password" 
                            id="admin-password" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gst-blue"
                            placeholder="비밀번호"
                            required
                        >
                    </div>
                    <div id="login-alert" class="hidden rounded-lg p-3">
                        <p class="text-sm" id="login-alert-text"></p>
                    </div>
                    <button 
                        type="submit" 
                        id="admin-login-btn"
                        class="w-full bg-gradient-to-r from-gst-blue to-gst-light-blue text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all"
                    >
                        <i class="fas fa-sign-in-alt mr-2"></i>로그인
                    </button>
                </form>
                <div class="mt-4 text-center">
                    <a href="/" class="text-sm text-gst-gray hover:text-gst-dark">
                        <i class="fas fa-home mr-1"></i>홈으로 돌아가기
                    </a>
                </div>
            </div>
        </div>

        <!-- 승인 대기 목록 -->
        <div id="pending-section" class="bg-white rounded-2xl shadow-2xl overflow-hidden hidden">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gst-dark">
                        <i class="fas fa-clock mr-2 text-yellow-500"></i>
                        승인 대기 중인 신청
                    </h2>
                    <button id="refresh-btn" class="text-gst-blue hover:text-gst-dark transition-colors">
                        <i class="fas fa-sync-alt mr-1"></i>새로고침
                    </button>
                </div>
            </div>

            <!-- 로딩 상태 -->
            <div id="loading" class="p-8 text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-gst-blue mb-4"></i>
                <p class="text-gst-gray">신청 목록을 불러오는 중...</p>
            </div>

            <!-- 빈 상태 -->
            <div id="empty-state" class="p-8 text-center hidden">
                <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                <p class="text-xl font-semibold text-gst-dark mb-2">승인 대기 중인 신청이 없습니다</p>
                <p class="text-gst-gray">모든 신청이 처리되었습니다.</p>
            </div>

            <!-- 신청 목록 -->
            <div id="pending-list" class="divide-y divide-gray-200 hidden">
                <!-- 동적으로 생성됨 -->
            </div>
        </div>
    </div>

    <!-- 거부 사유 모달 -->
    <div id="reject-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <h3 class="text-xl font-bold text-gst-dark mb-4">
                <i class="fas fa-ban text-red-500 mr-2"></i>가입 거부
            </h3>
            <p class="text-sm text-gst-gray mb-4" id="reject-user-info"></p>
            <textarea 
                id="reject-reason" 
                rows="4"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gst-blue resize-none mb-4"
                placeholder="거부 사유를 입력하세요..."
            ></textarea>
            <div class="flex gap-3">
                <button 
                    id="cancel-reject-btn"
                    class="flex-1 bg-gray-200 text-gst-dark py-2 rounded-lg hover:bg-gray-300 transition-colors"
                >
                    취소
                </button>
                <button 
                    id="confirm-reject-btn"
                    class="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-colors"
                >
                    거부 확인
                </button>
            </div>
        </div>
    </div>

    <script>
        let adminEmail = null;
        let currentRejectId = null;

        // 로그인 모달
        const loginModal = document.getElementById('login-modal');
        const adminLoginForm = document.getElementById('admin-login-form');
        const loginAlert = document.getElementById('login-alert');
        const loginAlertText = document.getElementById('login-alert-text');
        const adminInfo = document.getElementById('admin-info');
        const logoutBtn = document.getElementById('logout-btn');
        const pendingSection = document.getElementById('pending-section');

        function showLoginAlert(message, type = 'error') {
            loginAlert.className = `rounded-lg p-3 ${type === 'success' ? 'bg-green-50' : 'bg-red-50'}`;
            loginAlertText.className = `text-sm ${type === 'success' ? 'text-green-800' : 'text-red-800'}`;
            loginAlertText.textContent = message;
            loginAlert.classList.remove('hidden');
        }

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('admin-email').value.trim();
            const password = document.getElementById('admin-password').value;

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success && data.user.role === 'admin') {
                    adminEmail = data.user.email;
                    sessionStorage.setItem('admin_auth', JSON.stringify(data.user));
                    
                    loginModal.classList.add('hidden');
                    adminInfo.textContent = `${data.user.name} (${data.user.email})`;
                    logoutBtn.classList.remove('hidden');
                    pendingSection.classList.remove('hidden');
                    
                    loadPendingRegistrations();
                } else if (data.success && data.user.role !== 'admin') {
                    showLoginAlert('관리자 권한이 필요합니다.');
                } else {
                    showLoginAlert(data.error || '로그인에 실패했습니다.');
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginAlert('서버 연결에 실패했습니다.');
            }
        });

        // 로그아웃
        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('admin_auth');
            window.location.reload();
        });

        // 승인 대기 목록 로드
        async function loadPendingRegistrations() {
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');
            const pendingList = document.getElementById('pending-list');

            loading.classList.remove('hidden');
            emptyState.classList.add('hidden');
            pendingList.classList.add('hidden');

            try {
                const response = await fetch('/api/auth/pending', {
                    headers: {
                        'Authorization': `Bearer ${adminEmail}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    loading.classList.add('hidden');
                    
                    if (data.pending.length === 0) {
                        emptyState.classList.remove('hidden');
                    } else {
                        pendingList.innerHTML = data.pending.map(item => `
                            <div class="p-6 hover:bg-gray-50 transition-colors">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-2">
                                            <h3 class="text-lg font-semibold text-gst-dark">${item.name}</h3>
                                            <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">
                                                승인 대기
                                            </span>
                                        </div>
                                        <div class="space-y-1 text-sm text-gst-gray">
                                            <p>
                                                <i class="fas fa-envelope w-4"></i>
                                                <strong>이메일:</strong> ${item.email}
                                            </p>
                                            <p>
                                                <i class="fas fa-building w-4"></i>
                                                <strong>부서:</strong> ${item.company || '미입력'}
                                            </p>
                                            <p>
                                                <i class="fas fa-calendar w-4"></i>
                                                <strong>신청일:</strong> ${new Date(item.created_at).toLocaleString('ko-KR')}
                                            </p>
                                            ${item.reason ? `
                                                <p class="mt-2 p-3 bg-gray-50 rounded-lg">
                                                    <i class="fas fa-comment w-4"></i>
                                                    <strong>가입 사유:</strong><br>
                                                    ${item.reason}
                                                </p>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2 ml-4">
                                        <button 
                                            onclick="approveRegistration(${item.id}, '${item.name}')"
                                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors whitespace-nowrap"
                                        >
                                            <i class="fas fa-check mr-1"></i>승인
                                        </button>
                                        <button 
                                            onclick="showRejectModal(${item.id}, '${item.name}', '${item.email}')"
                                            class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors whitespace-nowrap"
                                        >
                                            <i class="fas fa-times mr-1"></i>거부
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        pendingList.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Load error:', error);
                loading.innerHTML = '<p class="text-red-500">목록을 불러오는데 실패했습니다.</p>';
            }
        }

        // 승인 처리
        window.approveRegistration = async function(id, name) {
            if (!confirm(`${name} 님의 가입을 승인하시겠습니까?`)) return;

            try {
                const response = await fetch('/api/auth/approve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminEmail}`
                    },
                    body: JSON.stringify({ id, action: 'approve' })
                });

                const data = await response.json();

                if (data.success) {
                    alert('가입이 승인되었습니다.');
                    loadPendingRegistrations();
                } else {
                    alert(data.error || '승인에 실패했습니다.');
                }
            } catch (error) {
                console.error('Approve error:', error);
                alert('서버 연결에 실패했습니다.');
            }
        };

        // 거부 모달
        const rejectModal = document.getElementById('reject-modal');
        const rejectUserInfo = document.getElementById('reject-user-info');
        const rejectReason = document.getElementById('reject-reason');
        const cancelRejectBtn = document.getElementById('cancel-reject-btn');
        const confirmRejectBtn = document.getElementById('confirm-reject-btn');

        window.showRejectModal = function(id, name, email) {
            currentRejectId = id;
            rejectUserInfo.textContent = `${name} (${email}) 님의 가입을 거부합니다.`;
            rejectReason.value = '';
            rejectModal.classList.remove('hidden');
        };

        cancelRejectBtn.addEventListener('click', () => {
            rejectModal.classList.add('hidden');
            currentRejectId = null;
        });

        confirmRejectBtn.addEventListener('click', async () => {
            const reason = rejectReason.value.trim();

            if (!reason) {
                alert('거부 사유를 입력해주세요.');
                return;
            }

            try {
                const response = await fetch('/api/auth/approve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminEmail}`
                    },
                    body: JSON.stringify({ 
                        id: currentRejectId, 
                        action: 'reject',
                        rejectReason: reason
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('가입이 거부되었습니다.');
                    rejectModal.classList.add('hidden');
                    loadPendingRegistrations();
                } else {
                    alert(data.error || '거부에 실패했습니다.');
                }
            } catch (error) {
                console.error('Reject error:', error);
                alert('서버 연결에 실패했습니다.');
            }
        });

        // 새로고침
        document.getElementById('refresh-btn').addEventListener('click', loadPendingRegistrations);

        // 페이지 로드 시 세션 확인
        window.addEventListener('load', () => {
            const admin = sessionStorage.getItem('admin_auth');
            if (admin) {
                const adminData = JSON.parse(admin);
                if (adminData.role === 'admin') {
                    adminEmail = adminData.email;
                    loginModal.classList.add('hidden');
                    adminInfo.textContent = `${adminData.name} (${adminData.email})`;
                    logoutBtn.classList.remove('hidden');
                    pendingSection.classList.remove('hidden');
                    loadPendingRegistrations();
                }
            }
        });
    </script>
</body>
</html>
