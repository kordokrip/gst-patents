<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>특허 데이터 가져오기 - GST Patent Management</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        .drop-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .drop-zone.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        .log-entry {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .stat-card {
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 헤더 -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="/" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left"></i> 돌아가기
                    </a>
                    <h1 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-file-import text-blue-600"></i>
                        특허 데이터 가져오기
                    </h1>
                </div>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-database"></i> 데이터베이스 관리
                </div>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 상태 카드 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">업로드된 파일</p>
                        <p class="text-3xl font-bold text-blue-600" id="stat-files">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-file-upload text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">파싱 완료</p>
                        <p class="text-3xl font-bold text-green-600" id="stat-parsed">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">저장 완료</p>
                        <p class="text-3xl font-bold text-purple-600" id="stat-saved">0</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-database text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">오류</p>
                        <p class="text-3xl font-bold text-red-600" id="stat-errors">0</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-exclamation-circle text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 파일 업로드 영역 -->
        <div class="bg-white rounded-lg shadow-sm p-8 mb-8">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-cloud-upload-alt text-blue-600"></i>
                JSON 파일 업로드
            </h2>
            
            <div id="drop-zone" class="drop-zone p-12 text-center">
                <i class="fas fa-file-upload text-6xl text-gray-400 mb-4"></i>
                <p class="text-lg font-medium text-gray-700 mb-2">
                    JSON 파일을 여기에 드래그하거나 클릭하여 선택하세요
                </p>
                <p class="text-sm text-gray-500 mb-4">
                    여러 개의 JSON 파일을 동시에 업로드할 수 있습니다
                </p>
                <input type="file" id="file-input" accept=".json" multiple class="hidden">
                <button id="select-files-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-folder-open mr-2"></i>
                    파일 선택
                </button>
            </div>

            <!-- 진행 상황 -->
            <div id="progress-section" class="mt-6 hidden">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">처리 진행률</span>
                    <span class="text-sm font-medium text-gray-700" id="progress-text">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progress-bar" class="progress-bar bg-blue-600 h-3 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- 액션 버튼 -->
            <div class="mt-6 flex gap-4">
                <button id="parse-btn" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-cogs mr-2"></i>
                    데이터 파싱 시작
                </button>
                <button id="save-btn" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-save mr-2"></i>
                    데이터베이스에 저장
                </button>
                <button id="clear-btn" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors">
                    <i class="fas fa-trash mr-2"></i>
                    초기화
                </button>
            </div>
        </div>

        <!-- 로그 영역 -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">
                    <i class="fas fa-list text-gray-600"></i>
                    처리 로그
                </h2>
                <button id="clear-log-btn" class="text-sm text-gray-600 hover:text-gray-900">
                    <i class="fas fa-eraser mr-1"></i>
                    로그 지우기
                </button>
            </div>
            <div id="log-container" class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500 text-center py-8">
                    <i class="fas fa-info-circle text-2xl mb-2"></i>
                    <p>로그가 여기에 표시됩니다</p>
                </div>
            </div>
        </div>

        <!-- 파싱 결과 미리보기 -->
        <div id="preview-section" class="bg-white rounded-lg shadow-sm p-6 mt-8 hidden">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-eye text-blue-600"></i>
                파싱 결과 미리보기
            </h2>
            <div id="preview-container" class="space-y-4"></div>
        </div>
    </main>

    <!-- 스크립트 -->
    <script src="../js/data-parser.js"></script>
    <script>
        // 전역 변수
        let uploadedFiles = [];
        let parsedPatents = [];
        let stats = {
            files: 0,
            parsed: 0,
            saved: 0,
            errors: 0
        };

        // DOM 요소
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const selectFilesBtn = document.getElementById('select-files-btn');
        const parseBtn = document.getElementById('parse-btn');
        const saveBtn = document.getElementById('save-btn');
        const clearBtn = document.getElementById('clear-btn');
        const clearLogBtn = document.getElementById('clear-log-btn');
        const progressSection = document.getElementById('progress-section');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const logContainer = document.getElementById('log-container');
        const previewSection = document.getElementById('preview-section');
        const previewContainer = document.getElementById('preview-container');

        // 통계 업데이트
        function updateStats() {
            document.getElementById('stat-files').textContent = stats.files;
            document.getElementById('stat-parsed').textContent = stats.parsed;
            document.getElementById('stat-saved').textContent = stats.saved;
            document.getElementById('stat-errors').textContent = stats.errors;
        }

        // 로그 추가
        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry py-2 px-3 mb-2 rounded ${
                type === 'error' ? 'bg-red-100 text-red-800' :
                type === 'success' ? 'bg-green-100 text-green-800' :
                type === 'warning' ? 'bg-yellow-100 text-yellow-800' :
                'bg-blue-100 text-blue-800'
            }`;
            
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const icon = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            
            logEntry.innerHTML = `<span class="text-gray-600">[${timestamp}]</span> ${icon} ${message}`;
            
            if (logContainer.firstChild?.classList?.contains('text-center')) {
                logContainer.innerHTML = '';
            }
            
            logContainer.insertBefore(logEntry, logContainer.firstChild);
        }

        // 진행률 업데이트
        function updateProgress(percent) {
            progressSection.classList.remove('hidden');
            progressBar.style.width = percent + '%';
            progressText.textContent = percent + '%';
        }

        // 파일 선택 버튼
        selectFilesBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // 파일 입력
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // 드래그 앤 드롭
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        // 파일 처리
        async function handleFiles(files) {
            const jsonFiles = Array.from(files).filter(file => file.name.endsWith('.json'));
            
            if (jsonFiles.length === 0) {
                addLog('JSON 파일을 선택해주세요', 'error');
                stats.errors++;
                updateStats();
                return;
            }

            addLog(`${jsonFiles.length}개의 JSON 파일을 업로드했습니다`, 'info');
            stats.files = jsonFiles.length;
            updateStats();

            // 파일 읽기
            const fileReaders = jsonFiles.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            resolve({ filename: file.name, data: jsonData });
                        } catch (error) {
                            addLog(`${file.name} 파싱 오류: ${error.message}`, 'error');
                            stats.errors++;
                            updateStats();
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            });

            try {
                uploadedFiles = await Promise.all(fileReaders);
                addLog(`${uploadedFiles.length}개 파일 읽기 완료`, 'success');
                parseBtn.disabled = false;
            } catch (error) {
                addLog('파일 읽기 중 오류 발생', 'error');
                stats.errors++;
                updateStats();
            }
        }

        // 데이터 파싱
        parseBtn.addEventListener('click', async () => {
            if (uploadedFiles.length === 0) {
                addLog('업로드된 파일이 없습니다', 'warning');
                return;
            }

            addLog('데이터 파싱을 시작합니다...', 'info');
            parseBtn.disabled = true;
            parsedPatents = [];
            stats.parsed = 0;
            updateStats();

            const total = uploadedFiles.length;
            
            for (let i = 0; i < uploadedFiles.length; i++) {
                const file = uploadedFiles[i];
                
                try {
                    const patent = window.patentDataParser.parsePatentFromJSON(file.data);
                    
                    if (patent) {
                        parsedPatents.push(patent);
                        stats.parsed++;
                        addLog(`✓ ${file.filename} - ${patent.title}`, 'success');
                    } else {
                        addLog(`✗ ${file.filename} - 파싱 실패`, 'error');
                        stats.errors++;
                    }
                } catch (error) {
                    addLog(`✗ ${file.filename} - 오류: ${error.message}`, 'error');
                    stats.errors++;
                }

                updateProgress(Math.round(((i + 1) / total) * 100));
                updateStats();
            }

            if (parsedPatents.length > 0) {
                addLog(`${parsedPatents.length}개 특허 데이터 파싱 완료`, 'success');
                saveBtn.disabled = false;
                displayPreview();
            } else {
                addLog('파싱된 데이터가 없습니다', 'error');
            }

            parseBtn.disabled = false;
        });

        // 미리보기 표시
        function displayPreview() {
            previewSection.classList.remove('hidden');
            previewContainer.innerHTML = '';

            const sampleSize = Math.min(5, parsedPatents.length);
            const samples = parsedPatents.slice(0, sampleSize);

            samples.forEach(patent => {
                const card = document.createElement('div');
                card.className = 'border border-gray-200 rounded-lg p-4';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="font-semibold text-lg">${patent.title}</h3>
                        <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${patent.category}
                        </span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                        <div><strong>특허번호:</strong> ${patent.patent_number}</div>
                        <div><strong>등록일:</strong> ${patent.registration_date || 'N/A'}</div>
                        <div><strong>출원인:</strong> ${patent.assignee}</div>
                        <div><strong>우선순위:</strong> ${patent.priority_score}/10</div>
                    </div>
                    <div class="mt-2 text-sm text-gray-700">
                        <strong>키워드:</strong> ${patent.technical_keywords.join(', ')}
                    </div>
                `;
                previewContainer.appendChild(card);
            });

            if (parsedPatents.length > sampleSize) {
                const moreText = document.createElement('p');
                moreText.className = 'text-center text-gray-500 text-sm mt-4';
                moreText.textContent = `외 ${parsedPatents.length - sampleSize}개 특허...`;
                previewContainer.appendChild(moreText);
            }
        }

        // 데이터베이스 저장
        saveBtn.addEventListener('click', async () => {
            if (parsedPatents.length === 0) {
                addLog('저장할 데이터가 없습니다', 'warning');
                return;
            }

            addLog('데이터베이스에 저장 중...', 'info');
            saveBtn.disabled = true;
            stats.saved = 0;
            updateStats();

            const batchSize = 10; // 배치 크기
            const batches = [];
            
            for (let i = 0; i < parsedPatents.length; i += batchSize) {
                batches.push(parsedPatents.slice(i, i + batchSize));
            }

            try {
                for (let i = 0; i < batches.length; i++) {
                    const batch = batches[i];
                    
                    for (const patent of batch) {
                        try {
                            const response = await fetch('/tables/patents', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(patent)
                            });

                            if (response.ok) {
                                stats.saved++;
                                addLog(`✓ 저장 완료: ${patent.title}`, 'success');
                            } else {
                                const errorData = await response.text();
                                addLog(`✗ 저장 실패: ${patent.title} - ${errorData}`, 'error');
                                stats.errors++;
                            }
                        } catch (error) {
                            addLog(`✗ 저장 오류: ${patent.title} - ${error.message}`, 'error');
                            stats.errors++;
                        }

                        updateStats();
                    }

                    const progress = Math.round(((i + 1) / batches.length) * 100);
                    updateProgress(progress);
                }

                addLog(`✅ 총 ${stats.saved}개 특허를 데이터베이스에 저장했습니다!`, 'success');
                
                setTimeout(() => {
                    if (confirm('저장이 완료되었습니다. 메인 페이지로 이동하시겠습니까?')) {
                        window.location.href = '/';
                    }
                }, 1000);

            } catch (error) {
                addLog(`데이터베이스 저장 중 오류: ${error.message}`, 'error');
                stats.errors++;
                updateStats();
            }

            saveBtn.disabled = false;
        });

        // 초기화
        clearBtn.addEventListener('click', () => {
            if (confirm('모든 데이터를 초기화하시겠습니까?')) {
                uploadedFiles = [];
                parsedPatents = [];
                stats = { files: 0, parsed: 0, saved: 0, errors: 0 };
                updateStats();
                progressSection.classList.add('hidden');
                progressBar.style.width = '0%';
                previewSection.classList.add('hidden');
                parseBtn.disabled = true;
                saveBtn.disabled = true;
                fileInput.value = '';
                addLog('초기화 완료', 'info');
            }
        });

        // 로그 지우기
        clearLogBtn.addEventListener('click', () => {
            logContainer.innerHTML = `
                <div class="text-gray-500 text-center py-8">
                    <i class="fas fa-info-circle text-2xl mb-2"></i>
                    <p>로그가 여기에 표시됩니다</p>
                </div>
            `;
        });

        // 초기 로그
        addLog('특허 데이터 가져오기 시스템이 준비되었습니다', 'success');
        addLog('JSON 파일을 업로드하여 시작하세요', 'info');
    </script>
</body>
</html>
